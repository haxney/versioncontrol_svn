<?php
class SvnPreCommitTestCase extends DrupalWebTestCase {
  /**
   * Implementation of getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('VersionControl_SVN hooks'),
      'description' => t('Test the functionality of the SVN hooks'),
      'group' => t('VersionControl'),
    );
  }

  function setUp() {
    parent::setUp('versioncontrol', 'versioncontrol_svn');

    $this->repo_path = file_directory_path() . '/svnrepo';
    $this->wc_path = file_directory_path() . '/svnwc';
    $this->pre_commit_hook = file_directory_path() . '/svnrepo/hooks/pre-commit';
    $this->pre_commit_file_src = drupal_get_path('module', 'versioncontrol_svn') . '/xsvn/xsvn-pre-commit.php';
    $this->xsvn_config_src = drupal_get_path('module', 'versioncontrol_svn') . '/xsvn/xsvn-config.php';
    $this->xsvn_dir = $this->repo_path . '/hooks/xsvn';
    $this->pre_commit_file_dst = $this->xsvn_dir . '/xsvn-pre-commit.php';
    $this->xsvn_config_dst = $this->xsvn_dir . '/xsvn-config.php';
    $this->pre_commit_text = "#!/bin/sh\n".
      "$this->repo_path/hooks/xsvn/xsvn-pre-commit.php $this->repo_path/hooks/xsvn/xsvn-config.php " .
      '$@';

    // Create subversion repository
    shell_exec("svnadmin create $this->repo_path");

    // Write the pre-commit hook
    $file = fopen($this->pre_commit_hook, 'w');
    fwrite($file, $this->pre_commit_text);
    fclose($file);
    chmod($this->pre_commit_hook, 0755);

    // Create the hooks/xsvn directory.
    mkdir($this->xsvn_dir);

    // Copy the xsvn files
    copy($this->pre_commit_file_src, $this->pre_commit_file_dst);
    copy($this->xsvn_config_src, $this->xsvn_config_dst);
    chmod($this->pre_commit_file_dst, 0755);
  }

  /**
   * Test printing of help message when incorrect number arguments is given.
   */
  function testInvalidArgHelp() {
    $result = shell_exec($this->pre_commit_hook . ' 2>&1 1> /dev/null');
    $this->assertEqual($result, "Usage: $this->pre_commit_file_dst <config file> REPO_PATH TX_NAME\n\n",
                      "Print help text when incorrect number of arguments is given.");
  }
}
